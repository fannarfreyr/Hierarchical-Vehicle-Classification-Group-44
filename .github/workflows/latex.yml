# This workflow will run every time you push to the main branch or create a Pull Request.
name: LaTeX PDF Generation

on:
  push:
    branches:
      - main
      - master
    # Restrict execution to only run if files in the report-src/ folder change
    paths:
      - 'report-src/**'
      - '.github/workflows/latex.yml'
  pull_request:
    branches:
      - main
      - master
    # Restrict execution to only run if files in the report-src/ folder change
    paths:
      - 'report-src/**'
      - '.github/workflows/latex.yml'
  # Allows you to manually trigger the workflow from the Actions tab in GitHub
  workflow_dispatch:

jobs:
  build_latex:
    # Use the latest Ubuntu environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        # Action to check out the repository code
        # IMPORTANT: Increase fetch-depth to 0 to allow push back to the same branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CRITICAL: Allows pushing a new commit back to the repo

      - name: Cache TeX Live Installation
        # Use the official cache action
        uses: actions/cache@v4
        with:
          # Use v2 key to force a save after the last successful fix
          key: ${{ runner.os }}-texlive-2024-v2
          # The path where xu-cheng/latex-action installs TeX Live (important!)
          path: ~/.cache/GHA-texlive

      - name: Compile LaTeX to PDF
        # Use the dedicated xu-cheng/latex-action for compilation
        uses: xu-cheng/latex-action@v2
        with:
          # Set the working directory to the source folder for auxiliary files (like arxiv.sty)
          working_directory: report-src/
          # root_file is now relative to the working_directory
          root_file: report.tex
          # Switched to xelatex for better modern font compatibility
          compiler: xelatex
          # Pass a safe argument to prevent injection of incompatible flags like '-pdf'
          args: -interaction=nonstopmode
          
      - name: Upload PDF Artifact
        # This step keeps the PDF available as a downloadable artifact in the Actions UI
        uses: actions/upload-artifact@v4
        with:
          name: Deep-Learning-Report-PDF
          # The compiled PDF will be in the report-src/ folder
          path: report-src/report.pdf
          # Keep the artifact available for 7 days
          retention-days: 7

      - name: Commit and Push PDF to Repository
        # New step to commit the generated PDF back into the report-src/ folder
        run: |
          # Configure Git user for the commit
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          
          # Add the generated PDF file
          git add report-src/report.pdf
          
          # Check if there are changes to commit (the PDF was updated)
          if ! git diff --staged --quiet; then
            git commit -m "Auto-generate: Update Deep Learning Report PDF"
            # Push the commit to the current branch using the GITHUB_TOKEN for authentication
            git push
          else
            echo "No changes in report.pdf detected. Skipping commit."
          fi